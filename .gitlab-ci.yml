# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/user/application_security/secret_detection/pipeline/configure
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
#stages:
#- build
#- test
#- deploy
#- review
#- dast
#- staging
#- canary
#- production
#- incremental rollout 10%
#- incremental rollout 25%
#- incremental rollout 50%
#- incremental rollout 100%
#- performance
#- cleanup
#sast:
#  stage: test
#include:
#- template: Auto-DevOps.gitlab-ci.yml
#test_job:
#  stage: test
#  script:
#    - echo "Uruchamianie testów..."
#    - echo "Testy zakończone pomyślnie!"

#image: docker:20.10
#
#services:
#  - name: docker:20.10-dind
#    alias: docker

#variables:
#  DOCKER_DRIVER: overlay2
#  DOCKER_TLS_CERTDIR: ""   # wyłącza TLS dla docker:dind
#
#stages:
#  - build
#  - test
#
#build_job:
#  stage: build
#  script:
#    - echo "Budowanie obrazu Dockera..."
#    - docker build -t myapp:latest .
#
#test_job:
#  stage: test
#  script:
#    - echo "Uruchamianie testów..."
#    - docker run --rm myapp:latest echo "Test OK"
#
stages:
  - test
services:
  - name: docker:24.0-dind
    alias: docker
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
# Job testowy dla wszystkich kontenerów
test-kontenerow:
  stage: test
  image: docker:24.0  # tylko CLI Dockera
  script:
    - echo "Sprawdzanie dostępności Dockera..."
    - docker info

    # Uruchomienie kontenerów z docker-compose
    - echo "Uruchamianie kontenerów..."
    - docker compose -f /git/containers/docker-compose.yml up -d

    # Funkcja czekająca na kontener
    - |
      wait_for_container() {
        local name=$1
        echo "Czekam na kontener $name..."
        until [ "$(docker inspect -f '{{.State.Running}}' $name 2>/dev/null)" == "true" ]; do
          sleep 2
        done
        echo "Kontener $name uruchomiony."
      }

    # Lista kontenerów z compose
    - containers=$(docker compose -f /git/containers/docker-compose.yml ps -q)

    # Czekanie na wszystkie kontenery
    - for c in $containers; do wait_for_container $c; done

    # Test frontendu
    - echo "Test frontendu..."
    - apk add --no-cache curl || true
    - curl -sSf http://localhost:5000 || echo "Frontend nie działa"

    # Test backendu
    - echo "Test backendu..."
    - curl -sSf http://localhost:5035 || echo "Backend nie działa"

    # Test bazy danych (sprawdzenie portu)
    - echo "Test bazy danych..."
    - nc -zv localhost 5432 || echo "Baza danych nie działa"

    # Lista uruchomionych kontenerów
    - echo "Uruchomione kontenery:"
    - docker ps

  tags:
    - docker




