# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/user/application_security/secret_detection/pipeline/configure
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
#stages:
#- build
#- test
#- deploy
#- review
#- dast
#- staging
#- canary
#- production
#- incremental rollout 10%
#- incremental rollout 25%
#- incremental rollout 50%
#- incremental rollout 100%
#- performance
#- cleanup
#sast:
#  stage: test
#include:
#- template: Auto-DevOps.gitlab-ci.yml
#test_job:
#  stage: test
#  script:
#    - echo "Uruchamianie testów..."
#    - echo "Testy zakończone pomyślnie!"

#image: docker:20.10
#
#services:
#  - name: docker:20.10-dind
#    alias: docker

#variables:
#  DOCKER_DRIVER: overlay2
#  DOCKER_TLS_CERTDIR: ""   # wyłącza TLS dla docker:dind
#
#stages:
#  - build
#  - test
#
#build_job:
#  stage: build
#  script:
#    - echo "Budowanie obrazu Dockera..."
#    - docker build -t myapp:latest .
#
#test_job:
#  stage: test
#  script:
#    - echo "Uruchamianie testów..."
#    - docker run --rm myapp:latest echo "Test OK"
#
stages:
  - test

test-containers:
  stage: test
  image: docker:24.0-dind
  services:
    - docker:24.0-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl docker-compose
  script:
    - echo "Sprawdzanie dostępności Dockera..."
    - docker info

    # Uruchomienie kontenerów z docker-compose
    - echo "Uruchamiam kontenery..."
    - docker compose -f /git/runner/docker-compose.yml up -d

    # Poczekaj chwilę, aż kontenery się uruchomią
    - echo "Czekam 10 sekund na start kontenerów..."
    - sleep 10

    # Test frontendu po nazwie usługi z docker-compose
    - echo "Test frontendu (web)..."
    - docker exec web curl -sSf http://localhost:5000 || echo "Frontend nie działa"

    # Test backendu
    - echo "Test backendu (api)..."
    - docker exec api curl -sSf http://localhost:5035 || echo "Backend nie działa"

    # Lista uruchomionych kontenerów
    - echo "Lista kontenerów:"
    - docker ps
  tags:
    - docker



