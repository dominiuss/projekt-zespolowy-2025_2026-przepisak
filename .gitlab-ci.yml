stages:
  - lint
  - build
  - test

# ---- GLOBAL CONFIG ----
variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  NUGET_PACKAGES: "$CI_PROJECT_DIR/.nuget/packages"
  DOCKER_HOST: unix:///var/run/docker.sock

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - containers/backend/.nuget/packages/

include:
  - template: Code-Quality.gitlab-ci.yml   # automatyczny raport Code Climate

# ===============================
#   BACKEND LINT (.NET 10 RC2)
# ===============================

lint_backend:
  stage: lint
  image: mcr.microsoft.com/dotnet/sdk:10.0
  script:
    - cd containers/backend
    - rm -f gl-code-quality-report.json
    - mkdir -p obj/Release/net10.0 bin/Release/net10.0
    - dotnet tool install -g dotnet-format
    - export PATH="$PATH:/root/.dotnet/tools"
    - dotnet clean PrzepisakApi.csproj
    - dotnet nuget locals all --clear
    - dotnet restore PrzepisakApi.csproj
  #  - dotnet format PrzepisakApi.csproj --verify-no-changes --report $(pwd)/gl-code-quality-report.json || true

    #- dotnet format PrzepisakApi.csproj --report ./gl-code-quality-report.json
  allow_failure: false
  #artifacts:
  #  reports:
  #    codequality: $(pwd)/gl-code-quality-report.json
  only:
    - merge_requests
    - branches

# ===============================
#   FRONTEND LINT (Vite + ESLint)
# ===============================

lint_frontend:
  stage: lint
  image: node:20
  cache:
    paths:
      - containers/frontend/my-app/node_modules/
  script:
    - cd containers/frontend/my-app
    - npm ci
    - npm run lint
  allow_failure: false
  only:
    - merge_requests
    - branches

# ===============================
#       BUILD BACKEND
# ===============================

build_backend:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:10.0
  script:
    - cd containers/backend
    - mkdir -p obj/Release/net10.0
    - mkdir -p bin/Release/net10.0
    - dotnet restore PrzepisakApi.csproj
    - dotnet build PrzepisakApi.csproj --configuration Release
  artifacts:
    paths:
      - containers/backend/bin/
  only:
    - merge_requests
    - branches

# ===============================
#       BUILD FRONTEND
# ===============================

build_frontend:
  stage: build
  image: node:20
  cache:
    paths:
      - containers/frontend/my-app/node_modules/
  script:
    - cd containers/frontend/my-app
    - npm ci
    - npm run build
  artifacts:
    paths:
      - containers/frontend/my-app/dist/
  only:
    - merge_requests
    - branches

test-backend:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:10.0
  script:
    - mkdir -p containers/backend/TestResults
    - cd containers/backend
    - dotnet restore PrzepisakApi.csproj
    - dotnet test PrzepisakApi.csproj --no-build --logger "trx;LogFileName=$(pwd)/TestResults/test-results.trx"
    - ls -l TestResults/
  artifacts:
    when: always
    reports:
      junit: TestResults/test-results.trx
    paths:
      - TestResults/test-results.trx

code_quality:
  stage: test
  image: docker:24.0.5
  needs:
    - lint_backend
    - lint_frontend
  artifacts:
    paths: [gl-code-quality-report.json]
