stages:
  - lint
  - build
  - test

# ---- GLOBAL CONFIG ----
variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  NUGET_PACKAGES: "$CI_PROJECT_DIR/.nuget/packages"

cache:
  paths:
    - .nuget/packages/

include:
  - template: Code-Quality.gitlab-ci.yml   # automatyczny raport Code Climate

# ===============================
#   BACKEND LINT (.NET 10 RC2)
# ===============================

lint_backend:
  stage: lint
  image: mcr.microsoft.com/dotnet/sdk:10.0
  script:
    - cd containers/backend
    - dotnet tool install -g dotnet-format
    - export PATH="$PATH:/root/.dotnet/tools"
    - dotnet restore
    - dotnet format --verify-no-changes
    - dotnet build --configuration Release
  only:
    - merge_requests
    - branches

# ===============================
#   FRONTEND LINT (Vite + ESLint)
# ===============================

lint_frontend:
  stage: lint
  image: node:20
  cache:
    paths:
      - containers/frontend/my-app/node_modules/
  script:
    - cd containers/frontend/my-app
    - npm ci
    - npm run lint
  only:
    - merge_requests
    - branches

# ===============================
#       BUILD BACKEND
# ===============================

build_backend:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:10.0
  script:
    - cd containers/backend
    - dotnet restore
    - dotnet build --configuration Release
  artifacts:
    paths:
      - containers/backend/bin/
  only:
    - merge_requests
    - branches

# ===============================
#       BUILD FRONTEND
# ===============================

build_frontend:
  stage: build
  image: node:20
  cache:
    paths:
      - containers/frontend/my-app/node_modules/
  script:
    - cd containers/frontend/my-app
    - npm ci
    - npm run build
  artifacts:
    paths:
      - containers/frontend/my-app/dist/
  only:
    - merge_requests
    - branches